<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="/manifest.json">
  <title>Live Event Log</title>
</head>
<body>
  <script src="https://unpkg.com/vue"></script>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/2.1.1/firebaseui.css">
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.yellow-deep_orange.min.css">
  <script src="https://www.gstatic.com/firebasejs/4.1.2/firebase.js"></script>
  <script src="https://cdn.firebase.com/libs/firebaseui/2.1.1/firebaseui.js"></script>
  <!-- Always shows a header, even in smaller screens. -->
  <div id="app" class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
    <header class="mdl-layout__header">
      <div class="mdl-layout__header-row">
        <!-- Title -->
        <span class="mdl-layout-title">Live Event Log</span>
        <!-- Add spacer, to align navigation to the right -->
        <div class="mdl-layout-spacer"></div>
        <nav class="mdl-navigation">
          <a class="mdl-navigation__link" href="">Link</a>
          <a class="mdl-navigation__link" href="">Link</a>
          <a class="mdl-navigation__link" href="">Link</a>
          <a class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" style="color: white">Log In</a>
        </nav>
      </div>
    </header>
    <div class="mdl-layout__drawer">
      <span class="mdl-layout-title">Title</span>
      <nav class="mdl-navigation">
        <a class="mdl-navigation__link" href="">Log In</a>
      </nav>
    </div>
    <main class="mdl-layout__content">
      <div class="page-content">
        <!-- Your content goes here -->
        <!-- Accent-colored raised button with ripple -->
        <button id="send-me-a-push" type="button" @click="sendMeAPush" style="position: absolute; right: 50px; bottom: 50px;" class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored">
          <i class="material-icons" style="color: white">backup</i>
        </button>
        <div class="mdl-tooltip mdl-tooltip--top" data-mdl-for="send-me-a-push">
          Send Me a Push
        </div>
        <br>
        <div class="notification" v-for="note of notifications">{{note}}</div>
        <hr>
        <div class="message" v-for="msg of messages">{{msg[0]}}: {{JSON.stringify(msg[1])}}</div>
        <virebase ref="virebase"
          api-key="AIzaSyBZVuEpoZJJhaE9xfHSs6hgCUs3FVXx03E"
          auth-domain="web-glue.firebaseapp.com"
          database-url="https://web-glue.firebaseio.com"
          project-id="web-glue"
          storage-bucket="web-glue.appspot.com"
          messaging-sender-id="555685705898"
        ></virebase>
      </div>
    </main>
  </div>
  
  <script>
  var Virebase = Vue.extend({
    data () {
      return {
        messaging: null,
        deviceToken: null
      }
    },
    template: '<span></span>',
    props: [
      'apiKey',
      'authDomain',
      'databaseURL',
      'projectId',
      'storageBucket',
      'messagingSenderId'
    ],
    created () {
      // Initialize Firebase
      firebase.initializeApp(this.$props)
      // Retrieve Firebase Messaging object.
      this.messaging = firebase.messaging()
      // Callback fired if Instance ID token is updated.
      this.messaging.onTokenRefresh(() => this.getToken())
    },
    methods: {
      requestPermission () {
        this.messaging.requestPermission()
        .then(() => {
          console.log('Notification permission granted.')
          this.getToken()
        })
        .catch((err) => {
          console.log('Unable to get permission to notify.', err)
        })
      },
      getToken () {
        // Get Instance ID token. Initially this makes a network call, once retrieved
        // subsequent calls to getToken will return from cache.
        this.messaging.getToken()
        .then((currentToken) => {
          if (currentToken) {
            //  sendTokenToServer(currentToken)
            //  updateUIForPushEnabled(currentToken)
            console.log('currentToken =', currentToken)
            this.deviceToken = currentToken
          } else {
            // Show permission request.
            console.log('No Instance ID token available. Request permission to generate one.')
            // Show permission UI.
            //  updateUIForPushPermissionRequired()
            //  setTokenSentToServer(false)
          }
        })
        .catch(function(err) {
          console.log('An error occurred while retrieving token. ', err)
          //  showToken('Error retrieving Instance ID token. ', err)
          //  setTokenSentToServer(false)
        })
      }
    }
  })
  
  var app = new Vue({
    el: '#app',
    components: {
      'virebase': Virebase
    },
    data: {
      messages: [],
      notifications: [],
      deviceToken: ''
    },
    created () {
      this.socket = io()
      // How to listen to all events
      this.socket.on('*', function (msg) {
        app.messages.push(msg)
      })
      this.socket.on('build-status', function (msg) {
        console.log(msg)
        let s = msg.commit_status
        app.notifications.push(msg)
      })
      // How to listen to a specific event
      this.socket.on('alert', function (msg) {
        alert(JSON.stringify(msg))
      })
    },
    mounted () {
      this.$refs.virebase.messaging.onMessage((payload) => {
        console.log('payload =', payload)
        this.notifications.push(`${payload.notification.title}: ${payload.notification.body}`)
      })
    },
    methods: {
      sendMeAPush () {
        this.$refs.virebase.messaging.getToken()
        .then((token) => {
          if (token) {
            this.socket.emit('send-me-a-push', {deviceToken: token})
          } else {
            this.$refs.virebase.messaging.requestPermission()
          }
        })
        .catch((err) => {
          console.log('err =', err)
        })
      }
    }
  })
  </script>
</body>
</html>
